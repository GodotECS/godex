name: CI
on:
  push:
    branches: main
    paths: doc_classes/*
  pull_request:
    branches: main
    paths: doc_classes/*

jobs:
  wiki:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      
      - name: Download makerst.py
        uses: carlosperate/download-file-action@v1.0.3
        with:
          file-url: https://raw.githubusercontent.com/godotengine/godot/master/doc/tools/makerst.py

      - name: Export XML documentation to RST and fix up for Github
        run: |
          mkdir .wiki
          python3 ./makerst.py --output .wiki/ doc_classes/ || /bin/true
          cd .wiki
          rename class_ '' *
          for i in *
          do
            sed -i -e '1d' -e '2i*This file is automatically generated. To make changes, please edit the corresponding XML file in the doc_classes/ folder instead.*' -e 's/:ref:`\([^<]*\)<\([^>]*\)>`/`\1 <\2>`_/g' -e '/\*\*Inherits/,+1d' $i
            mv $i $(grep -P -o -m 1 "\w+(?=\.xml)" $i).rst
          done
          echo "Done"
          
      - name: Sync files to wiki
        uses: kai-tub/external-repo-sync-action@v1
        with:
          source-directory: .wiki/
        env:
          GH_ACCESS_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}